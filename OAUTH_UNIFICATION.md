# OAuth URL Builder Unification

## Summary
Unified all OAuth authorization URL building logic into a single source of truth (`src/lib/oauthConfig.ts`). Fixed scopes to include all four required scopes. Removed all hardcoded redirect URIs and Supabase function references.

## Changes Made

### 1. Created `src/lib/oauthConfig.ts`
New centralized OAuth configuration file that exports:

- **`OAUTH_SCOPES`**: Single string constant
  ```
  "https://www.googleapis.com/auth/gmail.modify openid email profile"
  ```

- **`GOOGLE_REDIRECT_URI`**: Read from `VITE_GOOGLE_REDIRECT_URI` env variable
  - Fails fast with helpful console error if missing
  - No default fallback to prevent silent misconfiguration

- **`buildAuthUrl(state: string)`**: Single function to build OAuth URLs
  - Uses `client_id` from env
  - Uses `response_type=code`
  - Uses `redirect_uri=GOOGLE_REDIRECT_URI`
  - Uses `scope=OAUTH_SCOPES`
  - Uses `access_type=offline`
  - Uses `prompt=consent`
  - Uses `include_granted_scopes=true`
  - Accepts `state` parameter (typically user ID)

### 2. Updated Environment Variables (`.env`)
Added new required variable:
```
VITE_GOOGLE_REDIRECT_URI=https://app.bliztic.com/api/auth/google/callback
```

### 3. Updated `src/pages/Settings.tsx`
**Before:**
```typescript
import { buildGmailAuthUrl, ... } from '../lib/gmailAuth';

const authUrl = buildGmailAuthUrl(user.id, false);  // for Connect
const authUrl = buildGmailAuthUrl(user.id, true);   // for Reconnect
```

**After:**
```typescript
import { buildAuthUrl } from '../lib/oauthConfig';

const authUrl = buildAuthUrl(user.id);  // same for both
```

**Removed:**
- All references to `VITE_APP_DOMAIN` for building redirect URIs
- Hardcoded `/functions/v1/` path construction
- Import of `buildGmailAuthUrl` from gmailAuth

### 4. Updated `src/components/dashboard/GmailConnect.tsx`
**Before:**
- 50+ lines building OAuth URL manually
- Read `VITE_SUPABASE_URL` to build redirect URI
- Hardcoded scopes: `gmail.modify` and `userinfo.email` only
- Extensive console logging for debugging

**After:**
```typescript
import { buildAuthUrl } from '../../lib/oauthConfig';

const handleConnect = async () => {
  try {
    const authUrl = buildAuthUrl(userId);
    window.location.href = authUrl;
  } catch (error) {
    console.error('Failed to build OAuth URL:', error);
    setError(error instanceof Error ? error.message : 'Failed to start OAuth flow');
  }
};
```

**Removed:**
- All manual URL construction
- References to `VITE_SUPABASE_URL`
- Hardcoded `/functions/v1/gmail-oauth-callback` path
- Debug console logs (now handled by config fail-fast)

### 5. Updated `src/pages/GoogleCallback.tsx`
**Before:**
```typescript
const appDomain = import.meta.env.VITE_APP_DOMAIN || 'https://app.bliztic.com';
const redirectUri = `${appDomain}/api/auth/google/callback`;
```

**After:**
```typescript
import { GOOGLE_REDIRECT_URI } from '../lib/oauthConfig';

// Use GOOGLE_REDIRECT_URI directly in token exchange
redirect_uri: GOOGLE_REDIRECT_URI,
```

**Removed:**
- Manual redirect URI construction from `VITE_APP_DOMAIN`
- Local `redirectUri` variable

### 6. Updated `src/pages/OAuthDiagnostics.tsx`
**Before:**
```typescript
const redirectUri = `${import.meta.env.VITE_APP_DOMAIN || 'https://app.bliztic.com'}/api/auth/google/callback`;
const scopes = 'gmail.modify, openid, email, profile';
```

**After:**
```typescript
import { OAUTH_SCOPES, GOOGLE_REDIRECT_URI, buildAuthUrl } from '../lib/oauthConfig';

// Display actual config values
<code>{GOOGLE_REDIRECT_URI}</code>
<code>{OAUTH_SCOPES}</code>

// NEW: Preview OAuth URL
let previewAuthUrl = '';
try {
  previewAuthUrl = buildAuthUrl('diagnostics-test');
} catch (error) {
  console.error('Failed to build preview auth URL:', error);
}
```

**Added:**
- Preview OAuth URL section showing exact URL generated by `buildAuthUrl`
- Uses test state value `'diagnostics-test'` for preview
- Shows complete URL with all query parameters visible
- Help text explaining this is the actual generated URL

**Removed:**
- Manual redirect URI construction
- Hardcoded scopes string

### 7. Cleaned Up `src/lib/gmailAuth.ts`
**Removed:**
- `buildGmailAuthUrl()` function (replaced by `buildAuthUrl` in oauthConfig)
- All OAuth URL construction logic
- References to `VITE_APP_DOMAIN`

**Kept:**
- `refreshGmailToken()` - Token refresh logic
- `disconnectGmail()` - Disconnect logic
- `clearGmailTokensForReconnect()` - Reconnect preparation

## Scope Changes

### Before
Different scopes in different places:
- **Settings.tsx**: `gmail.modify`, `userinfo.email`
- **GmailConnect.tsx**: `gmail.modify`, `userinfo.email`
- **gmailAuth.ts**: `gmail.modify`, `openid`, `email`, `profile`

### After
Consistent everywhere:
```
https://www.googleapis.com/auth/gmail.modify openid email profile
```

All four scopes now included:
1. ✅ `gmail.modify` - Read and modify Gmail
2. ✅ `openid` - OpenID Connect authentication
3. ✅ `email` - User's email address
4. ✅ `profile` - User's basic profile information

## Redirect URI Changes

### Before
Multiple redirect URIs constructed in different ways:
- **Settings.tsx**: `${VITE_APP_DOMAIN}/functions/v1/gmail-oauth-callback`
- **GmailConnect.tsx**: `${VITE_SUPABASE_URL}/functions/v1/gmail-oauth-callback`
- **gmailAuth.ts**: `${VITE_APP_DOMAIN}/api/auth/google/callback`
- **GoogleCallback.tsx**: `${VITE_APP_DOMAIN}/api/auth/google/callback`
- **OAuthDiagnostics.tsx**: `${VITE_APP_DOMAIN}/api/auth/google/callback`

### After
Single redirect URI everywhere:
```
VITE_GOOGLE_REDIRECT_URI from .env
Default value: https://app.bliztic.com/api/auth/google/callback
```

**Removed:**
- All references to `/functions/v1/` paths
- All references to `VITE_SUPABASE_URL` for OAuth
- All manual redirect URI construction

## Benefits

### 1. Single Source of Truth
- One place to update scopes: `oauthConfig.ts`
- One place to configure redirect URI: `.env` file
- One function to build auth URLs: `buildAuthUrl()`

### 2. Fail-Fast Configuration
- Missing `VITE_GOOGLE_REDIRECT_URI` causes immediate error with helpful message
- Missing `VITE_GOOGLE_CLIENT_ID` causes immediate error
- No silent failures or default fallbacks that hide misconfigurations

### 3. Consistent Scopes
- All OAuth flows now request identical scopes
- No more discrepancies between components
- Matches the exact requirement: `gmail.modify openid email profile`

### 4. Simplified Components
- Settings.tsx: 3 lines instead of 20+ for Connect/Reconnect
- GmailConnect.tsx: 7 lines instead of 50+ for Connect
- No duplication of OAuth URL construction logic

### 5. Better Debugging
- Diagnostics panel now shows the actual generated OAuth URL
- Can visually inspect all query parameters
- Easy to verify redirect_uri matches Google Cloud Console

## Google Cloud Console Configuration

Add this exact redirect URI to your OAuth client:
```
https://app.bliztic.com/api/auth/google/callback
```

**Remove these old redirect URIs (if present):**
- ❌ `https://bazeyxgsgodhnwckttxi.supabase.co/functions/v1/gmail-oauth-callback`
- ❌ Any URIs with `/functions/v1/` path
- ❌ Any URIs pointing to Supabase URLs

## Testing Checklist

### Configuration
- [ ] Verify `VITE_GOOGLE_REDIRECT_URI` is in `.env`
- [ ] Verify redirect URI in Google Cloud Console matches exactly
- [ ] Check diagnostics page shows correct redirect URI

### Connect Flow
- [ ] Navigate to Settings
- [ ] Click "Connect Gmail"
- [ ] Verify redirect to Google with correct URL
- [ ] Check browser URL includes `redirect_uri=https://app.bliztic.com/api/auth/google/callback`
- [ ] Complete OAuth and verify connection

### Reconnect Flow
- [ ] Click "Reconnect Gmail" in Settings
- [ ] Verify redirect to Google with same URL
- [ ] Complete OAuth and verify tokens refreshed

### Diagnostics Preview
- [ ] Navigate to `/admin/oauth-diagnostics`
- [ ] Check "Preview OAuth URL" section shows complete URL
- [ ] Verify `redirect_uri` parameter in preview URL matches `GOOGLE_REDIRECT_URI`
- [ ] Verify `scope` parameter shows all four scopes

### GmailConnect Component
- [ ] Use Dashboard with GmailConnect component
- [ ] Click "Connect Gmail"
- [ ] Verify uses same redirect URI (not Supabase URL)

## Migration Notes

### Breaking Changes
- **Required**: Must add `VITE_GOOGLE_REDIRECT_URI` to `.env`
- **Required**: Must update Google Cloud Console redirect URIs
- **Code**: Components importing `buildGmailAuthUrl` must switch to `buildAuthUrl`

### Non-Breaking Changes
- Scopes expanded but backward compatible (more permissions requested)
- Old edge function callback still exists (not removed, just not used)
- Environment variables `VITE_APP_DOMAIN` and `VITE_SUPABASE_URL` still used elsewhere

## Rollback Plan

If issues arise:

1. **Revert .env change:**
   ```
   # Remove or comment out
   # VITE_GOOGLE_REDIRECT_URI=https://app.bliztic.com/api/auth/google/callback
   ```

2. **Revert code changes:**
   ```bash
   git revert <commit-hash>
   ```

3. **Restore old redirect URI in Google Cloud Console:**
   - Add back: `https://bazeyxgsgodhnwckttxi.supabase.co/functions/v1/gmail-oauth-callback`
   - Wait 5-10 minutes for propagation

## Files Modified

### Created
- `src/lib/oauthConfig.ts` - New OAuth configuration module

### Modified
- `.env` - Added `VITE_GOOGLE_REDIRECT_URI`
- `src/pages/Settings.tsx` - Use `buildAuthUrl` from oauthConfig
- `src/components/dashboard/GmailConnect.tsx` - Use `buildAuthUrl` from oauthConfig
- `src/pages/GoogleCallback.tsx` - Use `GOOGLE_REDIRECT_URI` from oauthConfig
- `src/pages/OAuthDiagnostics.tsx` - Use config exports, add preview URL
- `src/lib/gmailAuth.ts` - Removed `buildGmailAuthUrl` function

### Unchanged
- `src/lib/supabase.ts` - No changes
- `supabase/functions/gmail-oauth-callback/index.ts` - Old edge function unchanged
- All sync and Make webhook code - No changes

## Success Criteria

✅ Both Settings.tsx and GmailConnect.tsx use `buildAuthUrl`
✅ The only redirect used is `GOOGLE_REDIRECT_URI` from env
✅ The scopes string is exactly: `https://www.googleapis.com/auth/gmail.modify openid email profile`
✅ Diagnostics page shows preview OAuth URL with `redirect_uri=GOOGLE_REDIRECT_URI`
✅ No references to `/functions/v1/` for OAuth redirect
✅ No references to `VITE_SUPABASE_URL` for OAuth redirect
✅ Build succeeds with no errors
